# 09 実装計画（Windows + iOS 同時成立）

## 目的
- まず「1セッションが最後まで成立」する縦スライスを作る
- 次に「同期で全共有」まで通す
- その後に演出を積む


## 最優先ガード（バイブコーディング事故防止）
- 実装は必ず `00_PARITY_CONTRACT.md` を守る（Windows+iOS同一機能・同一データ・日本語固定）
- MVP範囲は `00_MVP_SCOPE_LOCK.md` で固定（勝手盛り禁止）
- 同期（M3）は `12_SYNC_API_SPEC.md` が唯一の正（契約がない同期実装は禁止）


---

## Definition of Done（DoD：完了条件）※置いてけぼり防止
以降、機能追加・修正は **これを満たして初めて完了**。

- Windowsで動作確認OK
- iOSで動作確認OK
- 同一アカウントで、persona/談議データが双方向同期する
- データスキーマversionが更新される場合は migration がある
- 例外時（通信断等）でもログが壊れない

---

## マイルストーン
### M0：骨組み（共通コア＋殻）
- 共通コアの骨（状態遷移・データモデル・同期インターフェース）
- Windows殻 / iOS殻：最低限の画面遷移
- DoD：両OSで起動・画面遷移できる

### M1：談議エンジン（縦スライス完走）
- Persona 3名固定でもよい：ターン制で会話が進む
- ルールガード最低限（誹謗中傷/脱線→司会介入）
- 結論→要約→Crystal生成
- DoD：両OSで完走

### M2：保存（ローカル）＋再現
- Session/Message/Crystal をローカル永続化
- 過去ログ閲覧、エクスポートJSON
- DoD：両OSで保存・閲覧

### M3：同期（全共有の最低ライン）
- Auth（ユーザー識別）
- persona/セッション/メッセージ/Crystal のクラウド同期
- 競合戦略（LWW＋追記マージ）を実装
- DoD：Windowsで作ったセッションがiOSで見える（逆も同様）

### M4：UX強化（操作性）
- Persona選抜のDrag配置
- スワイプ操作（設定/ログ、退席/同意）
- Long Pressで詳細表示
- DoD：両OSで同操作が成立（入力差は許容、機能差は不可）

### M5：演出（Research Lab感）
- ガラス表現強化
- 発言者フォーカス/浮遊感
- Crystal演出
- SE/BGM（最小）
- DoD：両OSで体験差が致命的にならない

---

## WBS（タスク分解）
### A. 基盤（共通）
- A1: リポジトリ構成（推奨：アプリは1つ／共通コア＋トークン＋文言＋契約を分離）
  - **原則**：OS別にロジックを置かない（UI入力差だけ許容）。共通ロジックは必ず `packages/shared_core` に集約。
  - **推奨ツリー（例）**：
    ```
    /
      docs/                         # このドキュメント群（契約/範囲/同期仕様/計画）
      apps/
        dangi_app/                  # クロスプラットフォームの“1アプリ”（UIと入力のみ）
      packages/
        shared_core/                # 状態遷移・会話エンジン・データモデル・同期クライアント
        ui_tokens/                  # 色/余白/角丸/影（単一ソース）
        motion_tokens/              # duration/curve（単一ソース）
        l10n_ja/                    # 日本語文言（ユーザー可視はここだけ）
      contracts/                    # OpenAPI / JSON Schema（同期契約・データ契約）
      backend/                      # API / DB / migrations
      tools/                        # grep / format / CIチェック
    ```
  - **例外**：技術スタックの都合で `apps/dangi_app` 配下に `windows/` `ios/` が分かれてもOK。ただし**同じUIコードと同じトークン参照**を維持。
- A2: lint/format/test最低限
- A3: スキーマversionとmigration枠
- A4: 共通UIトークン（色/余白/角丸/影）の定義と参照方法
- A5: 共通モーション定数（duration/curve）の定義と参照方法
- A6: 文言リソース（日本語固定）と“英語直書き禁止”のチェック

### B. Session状態遷移（共通コア）
- B1: 状態定義（BOOT〜DISSOLUTION）
- B2: 画面と状態の接続（殻側）
- B3: エラー時復帰（再試行/中断/再開）

### C. Persona管理（共通コア）
- C1: persona定義（JSON）読込/保存
- C2: バリデーション
- C3: セッションスナップショット

### D. Conversation Engine（共通コア）
- D1: プロンプトテンプレ（persona/ルール/テーマ）
- D2: ターン生成（ストリーミング表示）
- D3: ガード判定（warn/rewrite/eject）
- D4: 要約生成 + Crystal生成

### E. Persistence（共通コア）
- E1: Data Model実装（Session/Message/Crystal/Persona/Snapshot）
- E2: 保存/読込
- E3: エクスポート/インポート

### F. Sync（共通コア＋Backend）
- F1: Auth
- F2: Sync API（差分取得/更新）
- F3: 競合戦略（LWW＋追記マージ）
- F4: オフライン→復帰時の再同期

### G. UI/UX（殻）
- G1: ログ投影UI（吹き出し無し）
- G2: Heptagon Ring（2D）
- G3: フォーカス演出
- G4: Drag配置
- G5: スワイプ/ハプティクス（対応端末）

---

## 実装順（最重要）
1) 共通コアで「談議縦スライス」を先に動かす  
2) 状態遷移に統合して「1セッション完走」  
3) ローカル保存で資産化  
4) 同期（全共有）を通す  
5) UI/演出を磨く

---

## 実行手順（チェックリスト：AIはこの順でしか動かない）
> 運用ルール：1回の作業で「未完了のチェックを1つだけ」進める。  
> 完了時に必ず「変更ファイル一覧」「git diff要約」「動作確認手順（Windows/iOS）」を出す。  
> 不明点が出たら勝手に決めず、選択肢＋推奨＋理由を提示して停止する。

### M0（骨組み）
- [ ] A1 リポジトリ構成の確定（推奨ツリーを採用し、置き場を固定）
- [ ] A2 lint/format/test 最低限（CIは後回しでも “手元で1コマンド” は作る）
- [ ] A3 schema_version と migration 枠（空でも良いので“枠”を作る）
- [ ] A4 UIトークン（色/余白/角丸/影）を単一ソース化（OS別値禁止）
- [ ] A5 モーション定数（duration/curve）を単一ソース化（OS別値禁止）
- [ ] A6 日本語文言リソースを単一ソース化（ユーザー可視の英語直書き禁止チェックを含む）
- [ ] B1 状態定義（BOOT〜DISSOLUTION）を共通コアに実装
- [ ] B2 殻（Windows/iOS）の画面遷移を状態に接続（ロジックは殻に置かない）

### M1（談議エンジン：縦スライス完走）
- [ ] C1 Persona読込（MVPは3名固定でも可）＋最低限バリデーション
- [ ] D1 プロンプトテンプレ（persona/ルール/テーマ）確定
- [ ] D2 ターン生成（ストリーミング表示）で会話が進む
- [ ] D3 ガード判定（warn/rewrite/eject）最小で介入できる
- [ ] D4 要約生成＋Crystal生成（生成→保存はまだ不要、表示できればOK）
- [ ] B3 エラー時復帰（再試行/中断/再開）の最小導線

### M2（保存＋再現）
- [ ] E1 データモデル実装（Session/Message/Crystal/Persona/Snapshot）
- [ ] E2 ローカル保存/読込（作ったセッションが再現できる）
- [ ] E3 エクスポート/インポート（JSONで最低限）

### M3（同期：全共有の最低ライン）
- [ ] F1 Auth（ユーザー識別：最小）
- [ ] F2 Sync API（`12_SYNC_API_SPEC.md` 準拠：差分取得/更新）
- [ ] F3 競合戦略（LWW＋追記マージ）を実装（ログ破壊禁止）
- [ ] F4 オフライン→復帰時の再同期（破綻しないことを確認）

### M4（UX強化）
- [ ] G4 Drag配置（入力差はOK、機能差はNG）
- [ ] G5 スワイプ/ハプティクス（対応端末のみ、機能差を生まない）

### M5（演出）
- [ ] G1〜G3の演出強化（トークン/モーションは共通定数のみ）
