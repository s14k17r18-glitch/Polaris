# .claude/CLAUDE.md（最優先ルール）
このリポジトリで Claude Code が作業する際の「絶対に破ってはいけない運用ルール」。
**このファイルが最優先**。不明点・矛盾・仕様の空白があれば勝手に決めず停止して報告する。

対象リポジトリ：
- https://github.com/s14k17r18-glitch/Hokyoksei

---

# 最優先で読む（超重要：毎回必ず参照）
@docs/00_PARITY_CONTRACT.md
@docs/00_MVP_SCOPE_LOCK.md
@docs/12_SYNC_API_SPEC.md
@docs/09_IMPLEMENTATION_PLAN.md

# 常時ルール（運用の固定：毎回必ず参照）
@.claude/rules/10-runloop.md
@.claude/rules/20-git.md
@.claude/rules/30-test.md
@.claude/rules/40-release.md
@.claude/rules/50-style.md

---

## 0. 絶対条件（契約）
以下の docs は「唯一の正」。推測で仕様を盛らない。

- `docs/00_PARITY_CONTRACT.md`：Windows / iOS の同一機能・同一体験・日本語固定
- `docs/00_MVP_SCOPE_LOCK.md`：MVP範囲固定（勝手盛り禁止）
- `docs/12_SYNC_API_SPEC.md`：同期の契約（M3はこれ準拠以外禁止）
- `docs/09_IMPLEMENTATION_PLAN.md`：実行順（チェックリスト）

**契約に反する変更は禁止**。必要なら「例外申請」として停止して提案する。

---

## 1. 作業の進め方（毎回この順）
1) `docs/09_IMPLEMENTATION_PLAN.md` のチェックリストから **未完了を1つだけ**選ぶ  
2) 実装前に短く宣言する（必須）  
   - 今回やるチェック項目（ID含む）
   - 変更するファイル一覧
   - 実行するテスト（起動確認含む）
3) 実装する  
4) テストする（必須：起動確認を忘れない）  
5) テストNGなら、**テスト→修正→再テスト**をOKになるまで繰り返す  
6) 差分を要約し、Git操作（コミット→push→PR）を行う

---

## 2. 起動テスト（必須）
途中の起動確認を忘れない。最低限：
- Windows：アプリ起動→主要画面遷移→クラッシュ無し
- iOS：アプリ起動→主要画面遷移→クラッシュ無し

実装規模が小さくても実施する（UIや設定が壊れる事故が多い）。

---

## 3. テスト方針（必須）
- 単体テスト：共通コア（状態遷移/モデル/同期差分/ガード）を優先
- 統合テスト：縦スライス（1セッション完走）を優先
- Web / 拡張機能 / 外部のテストツールが使える場合：選定して併用して良い  
  ただし **ログイン・登録・APIキー入力が必要な作業は必ず停止してユーザー入力に委ねる**（後述）

---

## 4. 外部入力（ログイン・登録・APIキー）
以下が必要になったら **必ず作業を停止**してユーザーに依頼する：
- Webログイン / アカウント登録 / 2FA / CAPTCHA
- APIキーの入力 / シークレット作成
- 決済、同意が必要な画面操作

手順はこうする：
1) どのサイト/画面で何を入力するかを明確に指示
2) ユーザーの入力完了を待つ
3) 入力後に作業再開

**推測で入力しない。勝手に新規アカウントを作らない。**

---

## 5. Git / GitHub 運用（任せる範囲）
Claude Code は Git / GitHub 操作を行ってよい。ただし安全のため制約を守る。

### 5.1 ブランチ運用
- `main` へ直接 push しない
- ブランチ命名：`feature/<M#>-<topic>`（例：`feature/M1-conversation-engine`）

### 5.2 コミット運用
- 1コミットは小さく（目的が1つ）
- コミットメッセージは日本語でOK（例：`M1: ターン生成の最小実装`）
- `git status` と `git diff` を必ず確認してからコミット

### 5.3 PR運用
- push後、PRを作る（テンプレは `.claude/rules/20-git.md` 参照）
- PR本文に以下を必ず書く：
  - 対応したチェック項目
  - テスト結果（Windows/iOS起動確認含む）
  - 既知の制限 / 次の手

### 5.4 禁止
- `git push --force` 禁止（必要なら理由を書いて停止）
- 履歴改変（rebase/commit書き換え）を勝手にしない
- 大量ファイル変更を1PRに詰めない

---

## 6. 破壊的操作（禁止）
- リポジトリ外のファイルに触らない
- 削除系コマンド（rm/del/Remove-Item 等）は原則禁止  
  どうしても必要な場合は、対象パス・理由・影響を提示して停止し、ユーザー承認後に実行する

---

## 7. 完了報告（必須フォーマット）
作業完了時は必ず以下を出す：

- ✅ 実施したチェック項目：
- ✅ 変更ファイル一覧：
- ✅ テスト結果（Windows/iOS起動確認を含む）：
- ✅ 既知の制限：
- ✅ 次にやるチェック項目候補（最大3つ）：
